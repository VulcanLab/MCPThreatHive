# MCP Threat Platform Docker Compose
# Quick Start: docker compose up -d

services:
  mcp-threat-platform:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mcp-threat-platform
    ports:
      - "${SERVER_PORT:-5000}:5000"
    environment:
      - FLASK_ENV=${FLASK_ENV:-production}
      - PYTHONUNBUFFERED=1

      # LLM Configuration (from .env file)
      - LITELLM_API_BASE=${LITELLM_API_BASE}
      - LITELLM_API_KEY=${LITELLM_API_KEY}
      # LITELLM_MODEL=${LITELLM_MODEL}
      - MCP_INTERACTIVE_MODEL_SELECTION=false

      # Neo4j Configuration (internal docker network)
      # Hardcoded to override any local .env values that might point to localhost
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USERNAME=${NEO4J_USERNAME:-neo4j}
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-password}

      # Database (SQLite persistence)
      - DATABASE_URL=${DATABASE_URL:-sqlite:///data/mcp_threat_platform.db}

    volumes:
      - ./data:/app/data

    env_file:
      - .env

    depends_on:
      neo4j:
        condition: service_healthy

    restart: unless-stopped

    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:5000/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

    extra_hosts:
      - "host.docker.internal:host-gateway"

  neo4j:
    image: neo4j:5-community
    container_name: mcp-neo4j
    ports:
      - "7474:7474"
      - "7687:7687"

    environment:
      - NEO4J_AUTH=${NEO4J_USERNAME:-neo4j}/${NEO4J_PASSWORD:-password}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*

    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import
      - neo4j_plugins:/plugins

    restart: unless-stopped

    healthcheck:
      test: [ "CMD", "cypher-shell", "-u", "${NEO4J_USERNAME:-neo4j}", "-p", "${NEO4J_PASSWORD:-password}", "RETURN 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

volumes:
  neo4j_data:
    driver: local
  neo4j_logs:
    driver: local
  neo4j_import:
    driver: local
  neo4j_plugins:
    driver: local
